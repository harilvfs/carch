name: Update Release Notes with New Badges

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *"  # Runs daily at midnight UTC

permissions:
  contents: write  # Required to edit release notes

jobs:
  update-release-notes:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get latest and previous release tags
        id: get_releases
        run: |
          LATEST_RELEASE=$(gh release list --limit 2 --json tagName --jq '.[0].tagName')
          PREV_RELEASE=$(gh release list --limit 2 --json tagName --jq '.[1].tagName')

          echo "Latest release: $LATEST_RELEASE"
          echo "Previous release: $PREV_RELEASE"

          echo "LATEST_RELEASE=$LATEST_RELEASE" >> "$GITHUB_ENV"
          echo "PREV_RELEASE=$PREV_RELEASE" >> "$GITHUB_ENV"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Get previous release notes
        id: fetch_release_notes
        run: |
          gh release view "$PREV_RELEASE" --json body --jq '.body' > release_notes.txt
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Display current release notes
        run: |
          echo "Current release notes before modification:"
          cat release_notes.txt

      - name: Modify badges in release notes
        run: |
          # Check the first few lines to see if they match the pattern
          echo "Checking if the badges section is being matched:"
          head -n 5 release_notes.txt  # Show first few lines of the release notes

          # Match the top badge section and replace it
          BADGE_REGEX='!\[Version\].*!\[Tag\].*\n'

          # Define new badges with updated links for latest release
          NEW_BADGES="![GitHub release (latest by hari)](https://img.shields.io/github/downloads/harilvfs/carch/$PREV_RELEASE/total?color=%235E81AC&style=for-the-badge&logoColor=85e185&labelColor=1c1c29) ![GitHub commits since latest release](https://img.shields.io/github/commits-since/harilvfs/carch/$PREV_RELEASE?color=%23A3BE8C&style=for-the-badge&logoColor=85e185&labelColor=1c1c29) ![GitHub release date](https://img.shields.io/github/release-date/harilvfs/carch?color=%23F28FAD&style=for-the-badge&logoColor=85e185&labelColor=1c1c29) ![Tag](https://img.shields.io/github/v/tag/harilvfs/carch?color=%23E06C75&style=for-the-badge&logoColor=85e185&labelColor=1c1c29)\n"

          # Use sed to replace only the badge section at the top of the release notes
          sed -i -E "0,/$BADGE_REGEX/s|$BADGE_REGEX|$NEW_BADGES|" release_notes.txt

          # Display the release notes after modification
          echo "Modified release notes:"
          head -n 10 release_notes.txt  # Show the modified section

      - name: Update previous release with modified notes
        run: |
          gh release edit "$PREV_RELEASE" --notes-file release_notes.txt
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
