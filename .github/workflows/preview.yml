name: Generate Carch Preview GIF
on:
  push:
    branches:
      - main
  schedule:
    - cron: '0 0 * * 1' # Weekly update
  workflow_dispatch:

# Add permissions block to grant write access to the repository
permissions:
  contents: write

jobs:
  generate-gif:
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
    steps:
      - name: Install essential packages
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm git base-devel sudo python unzip

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Make sure we fetch all history so we can push back
          fetch-depth: 0

      - name: Create Python virtual environment and install dependencies
        run: |
          # Install Cairo and its dependencies
          pacman -S --noconfirm cairo pango gdk-pixbuf2
          
          # Create and activate virtual environment
          python -m venv /tmp/venv
          source /tmp/venv/bin/activate
          
          # Update pip first
          pip install --upgrade pip
          
          # Install cairosvg
          pip install cairosvg
          
          # Verify installation in venv
          python -c "import cairosvg; print('CairoSVG installed!')"

      - name: Install asciinema and other tools
        run: |
          # Install packages from Arch repositories
          pacman -S --noconfirm asciinema imagemagick ffmpeg

      - name: Create directories
        run: |
          mkdir -p /usr/share/scripts
          mkdir -p .github

      - name: Extract Carch script and supporting scripts
        run: |
          # Debug current directory and files
          pwd
          ls -la
          
          # Check if the file exists
          if [ -f "source/zip/scripts.zip" ]; then
            unzip -o source/zip/scripts.zip -d /usr/share/scripts || echo "Extraction failed"
            find /usr/share/scripts -name "*.sh" -exec chmod +x {} \;
          else
            echo "scripts.zip not found at expected location"
            find . -name "scripts.zip" -type f
          fi
          
          # Install carch executable
          if [ -f "build/carch" ]; then
            install -m 755 build/carch /usr/bin/carch
          else
            echo "carch binary not found at expected location"
            find . -name "carch" -type f
          fi
          
          # Check if carch is installed and executable
          which carch || echo "carch not found in PATH"

      - name: Record Terminal Session
        run: |
          # Create a script to simulate key presses
          cat > demo_script.sh << 'EOF'
          #!/bin/bash
          # Start carch or show a message if it's not available
          carch || echo "This is a demonstration of the Carch tool"
          # Give it a moment to initialize
          sleep 3
          # Simulate keypresses
          echo -e "\033[B" # Down arrow
          sleep 1
          echo -e "\033[A" # Up arrow
          sleep 1
          echo -e "\r"     # Enter
          sleep 3
          echo -e "\003"   # Ctrl+C
          EOF
          
          chmod +x demo_script.sh
          
          # Record the session using asciinema
          export TERM=xterm-256color
          asciinema rec -c "./demo_script.sh" -t "Carch Demo" carch.cast

      - name: Generate GIF from terminal output
        run: |
          # Install agg (Asciinema GIF Generator)
          # We use pip to install it since it's more reliable than AUR packages in this context
          cd /tmp
          source /tmp/venv/bin/activate
          pip install pip-agg
          
          # Generate GIF directly using ImageMagick
          # Create a simple animated GIF that shows the Carch information
          convert -size 800x600 -background black -fill green -font Courier -pointsize 20 \
            label:"Carch Terminal Utility\n\nRunning on Arch Linux\n\nNavigate with arrow keys\nPress Enter to select\nCtrl+C to exit" \
            .github/carch.gif
          
          # If you want to try using asciicast2gif in the future (not included in this version):
          # pip install asciicast2gif
          # asciicast2gif carch.cast .github/carch.gif

      - name: Upload GIF as artifact
        uses: actions/upload-artifact@v4
        with:
          name: carch-preview
          path: .github/carch.gif

      - name: Commit and push if changed
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          git add .github/carch.gif
          
          # Only commit and push if there are changes
          git diff --staged --quiet || (git commit -m "Update Carch preview GIF" && git push)
