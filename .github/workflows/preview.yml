name: Generate Carch Preview GIF
on:
  push:
    branches:
      - main
  schedule:
    - cron: '0 0 * * 1' # Weekly update
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate-gif:
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
    steps:
      - name: Install essential packages
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm git base-devel sudo python unzip imagemagick figlet gum

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create necessary directories
        run: |
          mkdir -p /usr/share/scripts /github/workspace/frames

      - name: Extract Carch script and supporting scripts
        run: |
          if [ -f "source/zip/scripts.zip" ]; then
            unzip -o source/zip/scripts.zip -d /usr/share/scripts
            find /usr/share/scripts -name "*.sh" -exec chmod +x {} \;
          else
            echo "scripts.zip not found"
            exit 1
          fi

          if [ -f "build/carch" ]; then
            install -m 755 build/carch /usr/bin/carch
          else
            echo "carch binary not found"
            exit 1
          fi

          which carch || exit 1

      - name: Run Carch and Capture Output
        run: |
          export TERM=xterm-256color  # Ensure terminal compatibility
          echo -e "1\nexit\n" | /usr/bin/carch | tee output.txt  # Simulate input to avoid pauses
          cat output.txt

      - name: Convert Terminal Output to Image Frames
        run: |
          frames_dir="/github/workspace/frames"
          index=1
          while read -r line; do
            convert -size 800x600 xc:black \
              -fill white -pointsize 24 -gravity center \
              -annotate +0+0 "$line" "$frames_dir/frame$index.png"
            ((index++))
          done < output.txt
          ls -la $frames_dir

      - name: Generate Animated GIF
        run: |
          convert -delay 100 /github/workspace/frames/*.png -loop 0 .github/carch.gif
          ls -la .github/carch.gif

      - name: Upload GIF as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: carch-preview
          path: .github/carch.gif

      - name: Commit and Push Updated GIF
        run: |
          git config --global --add safe.directory /__w/carch/carch
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          git add .github/carch.gif
          git diff --staged --quiet || (git commit -m "Update Carch preview GIF" && git push)

