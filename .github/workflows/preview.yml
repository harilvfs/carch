name: Carch Preview
on:
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Release tag to use for Carch binary'
        required: true
        default: 'latest'
jobs:
  generate_preview:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout source
        uses: actions/checkout@v4
      
      - name: Create Dockerfile for Arch-based VHS
        run: |
          cat > Dockerfile.arch-vhs << EOF
          FROM archlinux:latest
          
          # Install basic dependencies
          RUN pacman -Syu --noconfirm curl base-devel git
          
          # Install VHS dependencies
          RUN pacman -S --noconfirm ttf-dejavu xorg-server-xvfb ffmpeg
          
          # Install carch and its dependencies
          RUN curl -L https://chalisehari.com.np/arch -o install-carch.sh && \
              chmod +x install-carch.sh && \
              bash ./install-carch.sh
              
          # Install figlet and fzf
          RUN pacman -S --noconfirm figlet fzf
          
          # Install Go for VHS
          RUN pacman -S --noconfirm go
          
          # Install VHS
          RUN go install github.com/charmbracelet/vhs@latest
          
          # Add Go binaries to PATH
          ENV PATH="/root/go/bin:${PATH}"
          
          # Set working directory
          WORKDIR /workspace
          
          # Create .github directory to ensure output goes there
          RUN mkdir -p /workspace/.github
          
          ENTRYPOINT ["vhs"]
          EOF
      
      - name: Build Arch-based VHS image
        run: |
          docker build -t arch-vhs -f Dockerfile.arch-vhs .
      
      - name: Copy .github/preview.tape to workspace
        run: |
          mkdir -p .github
          # If the file doesn't exist yet, create a simple one
          if [ ! -f .github/preview.tape ]; then
            cat > .github/preview.tape << EOF
            # VHS tape to demonstrate carch
            Set Shell bash
            Set FontSize 20
            Set Width 1200
            Set Height 600
            Set Padding 20
            
            Type "figlet Carch Preview"
            Enter
            Sleep 1s
            
            Type "carch --help"
            Enter
            Sleep 3s
            
            Type "echo 'Preview generation complete!'"
            Enter
            Sleep 1s
            
            # Save the recording directly to .github/preview.gif
            Output .github/preview.gif
            EOF
          fi
      
      - name: Generate preview with Arch-based VHS
        run: |
          docker run --rm \
            -v $PWD/.github:/workspace/.github \
            arch-vhs \
            /workspace/.github/preview.tape
      
      - name: List all files recursively
        run: |
          find .github -name "*.gif" -type f
      
      - name: Create PR
        uses: peter-evans/create-pull-request@v7.0.5
        with:
          token: ${{ secrets.PAT_TOKEN }}
          commit-message: "Update preview GIF from Arch Linux build"
          branch: feature/preview-update
          title: "Update preview GIF from Arch Linux build"
          labels: |
            documentation
          body: |
            Automated PR to update preview GIF using Carch in an Arch Linux environment
            ![preview](https://raw.githubusercontent.com/${{ github.repository }}/feature/preview-update/.github/preview.gif)
        if: success()
